@namespace FitnessTracker.V1.Components
@using System.Linq
@using BlazorBootstrap
@using FitnessTracker.V1.Models

<div class="container-fluid overflow-x-auto">
    <BarChart @ref="chart" Width="@Width" Height="@Height" />
</div>

@code {
    [Parameter] public List<PoidsEntry> Entries { get; set; } = new();
    // ← NOUVEAU : Width/Height paramétrables
    [Parameter] public int Width { get; set; } = 400;
    [Parameter] public int Height { get; set; } = 300;


    private BarChart? chart;
    private ChartData? chartData;
    private BarChartOptions? chartOptions;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || chart is null || !Entries.Any()) return;

        BuildChart();
        await chart.InitializeAsync(chartData!, chartOptions!);
    }

    private void BuildChart()
    {
        // 1) Calcul des records max par exercice
        var records = Entries
            .GroupBy(e => e.Exercice)
            .Select(g => new
            {
                Exercice = g.Key,
                Record = g.Max(e => e.Poids)
            })
            .OrderByDescending(x => x.Record)
            .Take(10)  // ← on ne garde que les 10 premiers
            .ToList();

        // 2) Labels et data
        var labels = records.Select(r => r.Exercice).ToList();
        var dataPoints = records.Select(r => (double?)r.Record).ToList();

        // 3) Couleurs (une couleur différente par barre)
        var colors = labels
            .Select((_, i) => ColorUtility.CategoricalTwelveColors[i % ColorUtility.CategoricalTwelveColors.Length])
            .ToList();

        // 4) Dataset
        var dataset = new BarChartDataset
            {
                Label = "Record personnel",
                Data = dataPoints,
                BackgroundColor = colors,
                BorderColor = colors,
                BorderWidth = dataPoints.Select(_ => 1d).ToList()
            };

        // 5) Construction de ChartData et Options
        chartData = new ChartData
            {
                Labels = labels,
                Datasets = new List<IChartDataset> { dataset }
            };

        chartOptions = new BarChartOptions
            {
                Responsive = true,
                MaintainAspectRatio = false,
                Plugins = new()
                {
                    Title = new() { Display = true, Text = "Top 10 de vos records" }
                },
                Scales = new()
                {
                    X = new ChartAxes { Title = new ChartAxesTitle { Display = true, Text = "Exercice" } },
                    Y = new ChartAxes { Title = new ChartAxesTitle { Display = true, Text = "Poids (kg)" } }
                }
            };
    }
    public async Task RefreshAsync()
    {
        if (chart is not null && chartData is not null && chartOptions is not null)
            await chart.InitializeAsync(chartData, chartOptions);
    }
}
