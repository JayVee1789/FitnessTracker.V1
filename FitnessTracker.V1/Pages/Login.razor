@page "/login"


@inject AuthService AuthService
@inject SupabaseService2 SupabaseService
@inject NavigationManager Nav

<h3>Connexion</h3>

<div class="form-group">
    <label>Email</label>
    <input class="form-control" @bind="email" />
</div>

<div class="form-group">
    <label>Mot de passe</label>
    <input class="form-control" type="password" @bind="password" />
</div>

<button class="btn btn-primary mt-2" @onclick="LoginAsync">Connexion</button>

<p class="text-danger mt-2">@errorMessage</p>


<p class="mt-3">
    <a href="/mot-de-passe-oublie" class="link-secondary">Mot de passe oublié ?</a>
</p>
<p class="mt-3">
    Pas encore de compte ?
    <a href="/register" class="text-link">Créer un compte</a>
</p>
@code {
    private string email = "";
    private string password = "";
    private string errorMessage = "";

    private async Task LoginAsync()
    {
        var success = await AuthService.SignInAsync(email, password);
        if (success)
        {
            // ✅ Injecte le token utilisateur dans les headers pour les requêtes sécurisées
            SupabaseService.RefreshAuthHeaders();

            Console.WriteLine("✅ Connexion réussie");
            Nav.NavigateTo("/view-session");
        }
        else
        {
            errorMessage = "Échec de la connexion. Vérifie tes identifiants.";
            Console.WriteLine("❌ Connexion échouée");
        }
    }
}
