@page "/view-session"
@using FitnessTracker.V1.Models
@using FitnessTracker.V1.Services
@using FitnessTracker.V1.Services.ProgrammeGeneration
@using System.Text.Json
@using static FitnessTracker.V1.Models.Model
@inject SupabaseService2 SupabaseService
@inject PoidsService PoidsService
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject AuthService AuthService
@inject HttpClient Http
<h3>Visualiser une séance de programme</h3>

<div class="row mb-3">
    <div class="col-md-4">
        <label>Programme :</label>
        <select class="form-select" @onchange="OnProgrammeSelected">
            <option value="">-- Sélectionner --</option>
            @foreach (var prog in Programmes)
            {
                <option value="@prog.Id">@prog.Nom (@prog.DateDebut.ToShortDateString())</option>
            }
        </select>
    </div>

    @if (SelectedPlanAvailable)
    {
        <div class="col-md-4">
            <label>Semaine :</label>
            <select class="form-select" @onchange="OnSemaineChanged">
                @for (int i = 0; i < SelectedPlan?.Weeks.Count; i++)
                {
                    <option value="@i">Semaine @(i + 1)</option>
                }
            </select>
        </div>

        <div class="col-md-4">
            <label>Jour :</label>
            <select class="form-select" @onchange="OnJourChanged">
                @for (int j = 1; j <= 7; j++)
                {
                    <option value="@j">Jour @j</option>
                }
            </select>
        </div>
    }
</div>

@if (SelectedPlanAvailable)
{
    <div class="mb-3">
        <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#confirmModal">
            Supprimer ce programme
        </button>
    </div>
}

@if (Exercises.Any())
{
    <h5 class="mt-3">Séance du programme sélectionné</h5>
    <div class="mb-3">
        <button class="btn btn-outline-primary" @onclick="ToggleUnite">
            Affichage : @(AfficherEnLb ? "livres (lb)" : "kilos (kg)")
        </button>
    </div>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Exercice</th>
                <th>Séries</th>
                <th>Reps</th>
                <th>Repos (s)</th>
                <th>Poids</th>
                <th>% 1RM</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var ex in Exercises)
            {
                <tr class="@((ex.ObjectifAtteint ? "table-success" : ""))">
                    @* <td><a href="#" @onclick="() => ProposerRemplacement(ex)">@ex.ExerciseName</a></td> *@
                    <td>
                        <a href="#"
                        class="text-decoration-none"
                        data-bs-toggle="modal"
                        data-bs-target="#modalRemplacement"
                        @onclick="() => ProposerRemplacement(ex)">
                            @ex.ExerciseName
                        </a>
                    </td>
                    <td>@ex.Series</td>
                    <td>@ex.Repetitions</td>
                    <td>@ex.RestTimeSeconds</td>
                    <td>
                        @{
                            var poidsAffiche = ex.IsLb ? Math.Round(ex.PoidsUtilisé / 0.453592, 1) : Math.Round(ex.PoidsUtilisé, 1);
                            var suffix = ex.IsLb ? "lb" : "kg";
                        }
                        <input type="number"
                        class="form-control"
                        step="0.5"
                        @bind="ex.PoidsAffiche"
                        @key="AfficherEnLb.ToString() + ex.ExerciseName" />
                        <small class="text-muted">@suffix</small>
                    </td>
                    <td>
                        @{
                            var objectifKg = ex.Objectif * (1 + ex.Pourcentage1RM / 100.0);
                            var objectifAffiché = AfficherEnLb
                            ? Math.Round(ex.Objectif / 0.453592, 1) + " lb"
                            : Math.Round(ex.Objectif, 1) + " kg";
                        }
                        @objectifAffiché
                    </td>
                    @* <td>
                        @{
                            var obj = ex.IsLb ? Math.Round(ex.Objectif / 0.453592, 1) + " lb"
                            : Math.Round(ex.Objectif, 1) + " kg";
                        }
                        @obj
                    </td> *@
                    <td>
                        <button class="btn btn-sm btn-warning" @onclick="() => MarquerAtteint(ex)">Non atteint</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (SelectedPlanAvailable)
{
    <button class="btn btn-success" @onclick="SauvegarderSeance">
        Enregistrer les performances
    </button>
}
<br />
@if (SelectedPlanAvailable)
{
    <button class="btn btn-outline-success mt-2" @onclick="SauvegarderProgrammeModifié">
        💾 Sauvegarder les modifications du programme
    </button>
}
<!-- Modal de confirmation -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmModalLabel">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                Êtes-vous sûr de vouloir supprimer ce programme ? Cette action est irréversible.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" @onclick="ConfirmerSuppression">Oui, supprimer</button>
            </div>
        </div>
    </div>
</div>



@* <div class="modal fade" id="modalRemplacement" tabindex="-1" aria-labelledby="modalRemplacementLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalRemplacementLabel">🔁 Remplacer l'exercice</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                @if (ExerciceCible is not null)
                {
                    <p>Exercice actuel : <strong>@ExerciceCible.ExerciseName</strong></p>
                    <p>Suggestions :</p>
                    @foreach (var s in Suggestions)
                    {
                        <button class="btn btn-outline-primary w-100 mb-2" @onclick="@(() => RemplacerExercice(s))">
                            🔁 @s
                        </button>

                    }
                }
            </div>
        </div>
    </div>
</div> *@
<!-- Modal de remplacement -->
<!-- Modal de remplacement sans JS -->
<!-- Modal de remplacement -->
<div class="modal fade" id="modalRemplacement" tabindex="-1" aria-labelledby="modalRemplacementLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalRemplacementLabel">Remplacer l'exercice</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                @if (ExerciceCible is not null)
                {
                    <p>Exercice actuel : <strong>@ExerciceCible.ExerciseName</strong></p>
                    <p>Suggestions :</p>
                    @foreach (var s in Suggestions)
                    {
                        <div class="d-flex justify-content-between align-items-center mb-2 px-2">
                            <span>@s</span>
                            <button type="button"
                            class="btn btn-sm btn-outline-success"
                            data-bs-dismiss="modal"
                            @onclick="() => ConfirmerRemplacement(s)">
                                ✅ Sélectionner
                            </button>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    private List<ProgrammeModel> Programmes = new();
    private WorkoutPlan? SelectedPlan;
    private Guid SelectedProgrammeId;
    private string SelectedProgrammeSource = "auto";
    private int SelectedSemaineIndex = 0;
    private int SelectedJourIndex = 1;
    private List<ExerciceJour> Exercises = new();
    private DateTime SelectedProgrammeDate = DateTime.Today;
    public static bool AfficherEnLb { get; set; } = false;
    private ExerciceJour? ExerciceCible = null;
    private List<string> Suggestions = new();
    private string? userId;
    private string GetInputId(ExerciceJour ex) => $"{ex.ExerciseName}_{Guid.NewGuid()}";
    List<ExerciseDefinition> allExercises = new();
    private bool SelectedPlanAvailable => SelectedPlan is not null;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        try
        {
            userId = SupabaseService.GetCurrentUserId();
            Console.WriteLine("🔑 Utilisateur actuel : " + userId);
            // 🔄 Tente une synchro silencieuse sans casser la suite
            // await PoidsService.SyncFromSupabaseAsync();
            var supabaseEntries = await SupabaseService.GetEntriesAsync();
            await PoidsService.OverwriteEntriesAsync(supabaseEntries);
            Console.WriteLine($"✅ Synchro initiale : {supabaseEntries.Count} entrées chargées.");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Erreur de synchro Supabase → localStorage : " + ex.Message);
            // Optionnel : afficher une alerte ou logger
        }

        // ✅ Chargement des programmes comme avant
        Programmes = await SupabaseService.GetAllProgrammesAsync();
    }

    private async Task OnProgrammeSelected(ChangeEventArgs e)
    {
        Exercises.Clear();
        var value = e.Value?.ToString();
        if (Guid.TryParse(value, out var id))
        {
            var selectedProgramme = Programmes.FirstOrDefault(p => p.Id == id);

            if (selectedProgramme is not null)
            {
                SelectedProgrammeId = id;
                SelectedProgrammeSource = selectedProgramme.Source;
                SelectedPlan = JsonSerializer.Deserialize<WorkoutPlan>(selectedProgramme.Contenu);
                SelectedProgrammeDate = selectedProgramme.DateDebut;

                SelectedSemaineIndex = 0;
                SelectedJourIndex = 1;
                await ChargerSeance();
            }
        }
    }

    private async Task OnSemaineChanged(ChangeEventArgs e)
    {
        SelectedSemaineIndex = int.Parse(e.Value?.ToString() ?? "0");
        await ChargerSeance();
    }

    private async Task OnJourChanged(ChangeEventArgs e)
    {
        SelectedJourIndex = int.Parse(e.Value?.ToString() ?? "1");
        await ChargerSeance();
    }

    // private async Task ChargerSeance()
    // {
    //     Exercises.Clear();

    //     if (SelectedPlan is null || SelectedSemaineIndex >= SelectedPlan.Weeks.Count)
    //         return;

    //     var week = SelectedPlan.Weeks[SelectedSemaineIndex];
    //     var jour = week.Days.FirstOrDefault(d => d.DayIndex == SelectedJourIndex);

    //     if (jour == null || jour.IsRest)
    //     {
    //         Exercises = new()
    //         {
    //             new ExerciceJour
    //             {
    //                 ExerciseName = "Repos",
    //                 Series = 0,
    //                 Repetitions = 0,
    //                 RestTimeSeconds = 0,
    //                 Pourcentage1RM = 0,
    //                 PoidsUtilisé = 0
    //             }
    //         };
    //     }
    //     else
    //     {
    //         foreach (var ex in jour.Exercises)
    //         {
    //             var date = SelectedProgrammeDate.AddDays(SelectedSemaineIndex * 7 + (SelectedJourIndex - 1));

    //             double lastPoids = await PoidsService.GetPoidsForExerciceAtDateAsync(ex.ExerciseName, date) ??0;
    //             Exercises.Add(new ExerciceJour
    //                 {
    //                     ExerciseName = ex.ExerciseName,
    //                     Series = ex.Series,
    //                     Repetitions = ex.Repetitions,
    //                     RestTimeSeconds = ex.RestTimeSeconds,
    //                     Pourcentage1RM = ex.Pourcentage1RM,
    //                     PoidsUtilisé = lastPoids
    //                 });
    //         }
    //     }

    //     StateHasChanged();
    // }

    private async Task ChargerSeance()
    {
        Exercises.Clear();

        if (SelectedPlan is null || SelectedSemaineIndex >= SelectedPlan.Weeks.Count)
            return;

        var week = SelectedPlan.Weeks[SelectedSemaineIndex];
        var jour = week.Days.FirstOrDefault(d => d.DayIndex == SelectedJourIndex);

        if (jour == null || jour.IsRest)
        {
            Exercises = new()
            {
                new ExerciceJour
                {
                    ExerciseName = "Repos",
                    Series = 0,
                    Repetitions = 0,
                    RestTimeSeconds = 0,
                    Objectif =0,
                    Pourcentage1RM = 0,
                    PoidsUtilisé = 0,
                    ObjectifAtteint = false,
                    IsLb = false
                }
            };
        }
        else
        {
            var date = DateTime.Today;
            var localPoids = await PoidsService.GetAllLocalPoidsAsync();

            foreach (var ex in jour.Exercises)
            {
                // chercher poids correspondant à l’exercice à la bonne date
                var local = localPoids.FirstOrDefault(p =>
                    p.Exercice == ex.ExerciseName && p.Date.Date == date.Date);

                double poids = local?.Poids ?? 0;
                double facteurObjectif = 1 + (ex.Pourcentage1RM / 100.0);
                double objectif = poids * facteurObjectif;
                //remettre cette variable dans grace au profil 
                double coef = 2.5;
                double pourcentageRm = calculerObjectif(poids, coef);

                Exercises.Add(new ExerciceJour
                    {
                        ExerciseName = ex.ExerciseName,
                        Series = ex.Series,
                        Repetitions = ex.Repetitions,
                        RestTimeSeconds = ex.RestTimeSeconds,
                        Objectif = calculerObjectif(poids, coef),
                        Pourcentage1RM = pourcentageRm,
                        PoidsUtilisé = poids,
                        ObjectifAtteint = false,
                        IsLb = AfficherEnLb // ✅ ajout important ici

                    });
            }
        }

        StateHasChanged();
    }


    private void MarquerAtteint(ExerciceJour ex)
    {
        // Conversion en kg si saisi en lb
        double poidsSaisiKg = ex.IsLb ? ex.PoidsUtilisé * 0.453592 : ex.PoidsUtilisé;

        // Calcul de l’objectif à partir du dernier poids connu (PoidsUtilisé est la référence)
        double objectifKg = ex.Objectif * (1 + ex.Pourcentage1RM / 100.0);

        ex.ObjectifAtteint = poidsSaisiKg >= objectifKg;
    }
    private void UpdatePoids(ChangeEventArgs e, ExerciceJour ex)
    {
        if (double.TryParse(e.Value?.ToString(), out double val))
        {
            // Toujours stocker en kg
            ex.PoidsUtilisé = AfficherEnLb ? val * 0.453592 : val;
        }
    }
    private async Task SauvegarderProgrammeModifié()
    {
        if (SelectedPlan is null || SelectedProgrammeId == Guid.Empty)
            return;

        try
        {
            var programme = Programmes.FirstOrDefault(p => p.Id == SelectedProgrammeId);
            if (programme is not null)
            {
                programme.Contenu = JsonSerializer.Serialize(SelectedPlan);
                var success = await SupabaseService.UpdateProgrammeUnifiedAsync(programme);

                if (success)
                {
                    Console.WriteLine("✅ Programme mis à jour avec succès.");
                }
                else
                {
                    Console.WriteLine("❌ Erreur lors de la mise à jour du programme.");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Exception durant la mise à jour du programme : {ex.Message}");
        }
    }

    // private async Task ProposerRemplacement(ExerciceJour ex)
    // {
    //     ExerciceCible = ex;
    //     List<ExerciseDefinition> allExercises = new();


    //     var version = DateTime.Now.Ticks;
    //     allExercises = await Http.GetFromJsonAsync<List<ExerciseDefinition>>($"data/ExercicesListeLocal.json?v={version}") ?? new();

    //     var tous = new List<string>
    //     {
    //         "Pompes", "Tractions", "Développé militaire", "Rowing barre", "Curl biceps", "Hip Thrust"
    //     };

    //     Suggestions = tous
    //         .Where(e => e != ex.ExerciseName)
    //         .OrderBy(_ => Guid.NewGuid())
    //         .Take(2)
    //         .ToList();

    //     // Pas besoin de JS ici, le bouton dans le tableau ouvre le modal
    // }
    private async Task ProposerRemplacement(ExerciceJour ex)
    {
        ExerciceCible = ex;
        var version = DateTime.Now.Ticks;
        allExercises = await Http.GetFromJsonAsync<List<ExerciseDefinition>>($"data/ExercicesListeLocal.json?v={version}") ?? new();
        var original = allExercises.FirstOrDefault(e => e.Name == ex.ExerciseName);
        if (original == null)
        {
            Console.WriteLine("⚠️ Exercice source introuvable dans la base.");
            Suggestions = new(); return;
        }

        string baseCategory = original.Category?.Split('/').FirstOrDefault()?.Trim() ?? "";

        Suggestions = allExercises
            .Where(e =>
                e.Name != original.Name &&
                e.Origin == original.Origin &&
                e.Description == original.Description &&
                e.Category.StartsWith(baseCategory, StringComparison.OrdinalIgnoreCase))
            .OrderBy(_ => Guid.NewGuid())
            .Select(e => e.Name)
            .Take(2)
            .ToList();

        Console.WriteLine($"🔁 Suggestions trouvées pour {original.Name} : {string.Join(", ", Suggestions)}");
    }


    // private void ConfirmerRemplacement(string nouveau)
    // {
    //     if (ExerciceCible is null) return;

    //     ExerciceCible.ExerciseName = nouveau;
    //     ExerciceCible = null;

    //     StateHasChanged();
    // }

    private async Task ConfirmerRemplacement(string nouveau)
    {
        if (ExerciceCible is null || SelectedPlan is null) return;

        //  Mémoriser l'ancien nom AVANT le remplacement
        string ancienNom = ExerciceCible.ExerciseName;

        //  Remplacer dans la séance affichée
        ExerciceCible.ExerciseName = nouveau;

        //  Remplacer aussi dans le plan du programme (WorkoutPlan)
        var semaine = SelectedPlan.Weeks.ElementAtOrDefault(SelectedSemaineIndex);
        var jour = semaine?.Days.FirstOrDefault(d => d.DayIndex == SelectedJourIndex);

        var exOriginal = jour?.Exercises.FirstOrDefault(e => e.ExerciseName == ancienNom);
        if (exOriginal is not null)
        {
            exOriginal.ExerciseName = nouveau;
        }

        try
        {
            // ✅ Sauvegarder le programme modifié après remplacement
            await SauvegarderProgrammeModifié();
            Console.WriteLine("✅ Programme mis à jour après remplacement.");
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }


        ExerciceCible = null;
        StateHasChanged();
    }

    private async Task RemplacerExercice(string nouveau)
    {
        if (ExerciceCible is null)
            return;

        ExerciceCible.ExerciseName = nouveau;
        ExerciceCible = null;

        // await JS.InvokeVoidAsync("hideModal", "modalRemplacement");
        // 👉 Pas de await → compatible Hot Reload
        JS.InvokeVoidAsync("hideModal", "modalRemplacement").AsTask();
        StateHasChanged();
    }

    // private async Task SauvegarderSeance()
    // {
    //     foreach (var ex in Exercises)
    //     {
    //         if (ex.ExerciseName == "Repos") continue;

    //         var poidsKg = AfficherEnLb ? ex.PoidsUtilisé * 0.453592 : ex.PoidsUtilisé;

    //         var entry = new PoidsEntry
    //             {
    //                 Exercice = ex.ExerciseName,
    //                 Date = DateTime.Today,
    //                 Poids = poidsKg
    //             };

    //         var local = new PoidsEntryLocal
    //             {
    //                 Exercice = ex.ExerciseName,
    //                 Date = DateTime.Today,
    //                 Poids = poidsKg
    //             };

    //         try
    //         {
    //             await PoidsService.SupprimerDepuisSupabaseAsync(ex.ExerciseName, DateTime.Today);
    //             await PoidsService.AddEntryAsync(entry, local);
    //             Console.WriteLine($" Entrée ajoutée : {entry.Exercice} - {entry.Poids} kg");
    //         }
    //         catch (Exception exerer)
    //         {
    //             Console.WriteLine("❌ Exception capturée dans SauvegarderSeance");
    //             Console.WriteLine("❌ Erreur sauvegarde : " + exerer.Message);
    //         }
    //     }
    //     // 🔄 Sauvegarder les éventuelles modifications du programme
    //     await SauvegarderProgrammeModifié();
    //     Console.WriteLine("✅ Programme sauvegardées");


    //     Console.WriteLine("✅ Performances sauvegardées sans doublon ni erreur d'unité");
    // }
    private async Task SauvegarderSeance()
    {
        foreach (var ex in Exercises)
        {
            if (ex.ExerciseName == "Repos") continue;

            // ⚠️ Utiliser IsLb (pas AfficherEnLb)
            var poidsKg = ex.IsLb ? ex.PoidsUtilisé * 0.453592 : ex.PoidsUtilisé;

            var entry = new PoidsEntry
                {
                    Exercice = ex.ExerciseName,
                    Date = DateTime.Today,
                    Poids = poidsKg,
                    UserId = userId,
                    EnLb  = ex.IsLb
                };

            var local = new PoidsEntryLocal
                {
                    Exercice = ex.ExerciseName,
                    Date = DateTime.Today,
                    Poids = poidsKg,
                    UserId = userId,
                    EnLb = ex.IsLb
                };

            try
            {
                // 🔁 méthode unifiée pour gérer doublons + synchro
                await PoidsService.SaveEntryUnifiedAsync(entry, local);
                Console.WriteLine($"✅ Entrée sauvegardée : {entry.Exercice} - {entry.Poids} kg");
            }
            catch (Exception exerer)
            {
                Console.WriteLine("❌ Erreur sauvegarde : " + exerer.Message);
            }
        }

        // 🔄 Sauvegarde le programme aussi
        await SauvegarderProgrammeModifié();
        Console.WriteLine("✅ Séance et programme sauvegardés avec succès.");
    }

    private string message = ""; // Affichage du message de succès ou erreur




    private async Task ConfirmerSuppression()
    {
        var modal = await JS.InvokeAsync<IJSObjectReference>("bootstrap.Modal.getInstance", "#confirmModal");
        await modal.InvokeVoidAsync("hide");

        if (SelectedProgrammeId != Guid.Empty)
        {
            var success = await SupabaseService.DeleteProgrammeUnifiedAsync(SelectedProgrammeId, SelectedProgrammeSource);

            if (success)
            {
                // Réinitialisation complète
                SelectedPlan = null;
                SelectedProgrammeId = Guid.Empty;
                SelectedProgrammeSource = "auto";
                Exercises.Clear();

                Programmes = await SupabaseService.GetAllProgrammesAsync();

                // Forcer le rendu
                StateHasChanged();
            }
        }
    }

    private double ConvertToDisplayUnit(double poidsKg) =>
    AfficherEnLb ? Math.Round(poidsKg / 0.453592, 1) : poidsKg;

    private double ConvertToKg(double valeurAffichee) =>
        AfficherEnLb ? Math.Round(valeurAffichee * 0.453592, 2) : valeurAffichee;

    private void OnPoidsChanged(string? valueStr, ExerciceJour ex)
    {
        if (double.TryParse(valueStr, out double val))
        {
            ex.PoidsUtilisé = ConvertToKg(val);
        }
    }

    private double GetDisplayPoids(ExerciceJour ex)
    {
        return AfficherEnLb ? Math.Round(ex.PoidsUtilisé / 0.453592, 1) : Math.Round(ex.PoidsUtilisé, 1);
    }

    private void SetDisplayPoids(ChangeEventArgs e, ExerciceJour ex)
    {
        if (double.TryParse(e.Value?.ToString(), out double val))
        {
            ex.PoidsUtilisé = AfficherEnLb ? val * 0.453592 : val;
        }
    }

    private async void ToggleUnite()
    {
        AfficherEnLb = !AfficherEnLb;

    }

    /// <summary>
    /// Ajoute un pourcentage au poids de départ.
    /// Exemple : poids = 100, pourcentage = 2.5  → 102.5
    /// </summary>
    /// <param name="poids">Le poids de départ (double).</param>
    /// <param name="pourcentage">Le pourcentage à appliquer (double).</param>
    /// <returns>Le nouveau poids avec le pourcentage ajouté.</returns>
    private double calculerObjectif(double poidsUtilisé, double coef)
    {
        // 1 + (pourcentage / 100) donne le facteur multiplicatif
        double resultat = poidsUtilisé * (1 + coef / 100.0);
        return Math.Round(resultat, 1, MidpointRounding.AwayFromZero);// MidpointRounding.AwayFromZero      ↑
        // assure 1.25 → 1.3 plutôt que 1.2 si jamais vous êtes à mi‐chemin.
    }

    private double GetPoidsAffiché(ExerciceJour ex) =>
    AfficherEnLb ? Math.Round(ex.PoidsUtilisé / 0.453592, 1) : Math.Round(ex.PoidsUtilisé, 1);

    private void SetPoidsAffiché(ExerciceJour ex, string? val)
    {
        if (double.TryParse(val, out double result))
            ex.PoidsUtilisé = AfficherEnLb ? Math.Round(result * 0.453592, 2) : result;
    }


    public class ExerciceJour
    {
        public string ExerciseName { get; set; } = "";
        public int Series { get; set; }
        public int Repetitions { get; set; }
        public int RestTimeSeconds { get; set; }
        public double Pourcentage1RM { get; set; }
        public double PoidsUtilisé { get; set; }
        public double Objectif { get; set; }
        public bool ObjectifAtteint { get; set; } = false;
        public bool IsLb { get; set; } = false;
        public bool RefreshFlag { get; set; } = false;
        public double PoidsAffiche
        {
            get => ViewSession.AfficherEnLb
            ? Math.Round(PoidsUtilisé / 0.453592, 1)
            : Math.Round(PoidsUtilisé, 1);
            set => PoidsUtilisé = ViewSession.AfficherEnLb
                ? Math.Round(value * 0.453592, 2)
                : Math.Round(value, 1);
        }
    }
}
